<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#84a99c">
    <link rel="apple-touch-icon" href="icono.png">
    <link rel="icon" type="image/png" href="icono.png">

    <title>Baddie Wellness Tracker AI</title>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@600;700&family=Nunito:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    
    <style>
        :root { 
            --primary: #84a99c; --primary-dark: #6b8d81; --bg-color: #fdf6f5; 
            --text-main: #5a504b; --text-light: #a09894; --accent: #f4a298; 
            --danger: #e74c3c; --success: #81c784; --gold: #ffd54f;
        }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body { 
            font-family: 'Nunito', sans-serif; background-color: var(--bg-color); 
            color: var(--text-main); margin: 0; padding: 15px; 
            display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; 
            padding-top: env(safe-area-inset-top); padding-bottom: env(safe-area-inset-bottom);
        }

        body::before {
            content: ""; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background-image: url('fondo.png'); background-size: cover; background-position: center; z-index: -1;
        }

        .app-wrapper { width: 100%; max-width: 500px; display: flex; flex-direction: column; gap: 12px; padding-bottom: 30px; }
        
        .baddie-banner { 
            background-image: linear-gradient(rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0.1)), url('banner.png'); 
            background-size: cover; background-position: center; color: white; text-align: center; 
            padding: 45px 20px 30px 20px; border-radius: 24px; box-shadow: 0 8px 20px rgba(0,0,0,0.08);
            position: relative; overflow: hidden;
        }
        
        .date-mini {
            position: absolute; top: 10px; right: 10px;
            background: rgba(255, 255, 255, 0.9); border-radius: 30px; padding: 3px 10px; 
            display: flex; align-items: center; gap: 5px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            backdrop-filter: blur(4px); z-index: 10;
        }
        .date-mini i { font-size: 12px; color: var(--primary); }
        .date-mini input { border: none; background: transparent; font-size: 10px; font-weight: 900; color: var(--text-main); outline: none; font-family: 'Nunito'; width: 85px; cursor: pointer; }

        .baddie-banner h1 {
            margin: 0; font-size: 34px; font-family: 'Fredoka', sans-serif; font-weight: 700; color: #ffffff;
            text-shadow: -2px -2px 0 #5a504b, 2px -2px 0 #5a504b, -2px 2px 0 #5a504b, 2px 2px 0 #5a504b, 3px 5px 0 rgba(90, 80, 75, 0.2);
            letter-spacing: 1px; line-height: 1.1;
        }

        .tabs { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        .tab-btn { 
            background: #ffffff; border: none; padding: 12px 5px; border-radius: 16px; 
            font-family: 'Nunito'; font-size: 10px; font-weight: 800; color: var(--text-light); 
            display: flex; flex-direction: column; align-items: center; gap: 4px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); cursor: pointer;
        }
        .tab-btn i { font-size: 24px; color: var(--text-light); }
        .tab-btn.active { background: var(--primary); color: white; }
        .tab-btn.active i { color: white; }

        .glass-panel { background: rgba(255, 255, 255, 0.88); backdrop-filter: blur(15px); border-radius: 24px; padding: 20px; box-shadow: 0 8px 30px rgba(0,0,0,0.05); }

        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.2s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .alert-box { 
            background-color: var(--danger); color: white; text-align: center; padding: 12px; 
            border-radius: 14px; font-weight: 800; font-size: 12px; display: none; 
            align-items: center; justify-content: center; gap: 8px; margin-bottom: 8px; 
            box-shadow: 0 4px 12px rgba(231, 76, 60, 0.3); animation: shake 0.5s ease-in-out;
        }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }

        .form-group { margin-bottom: 12px; }
        label { display: block; font-size: 10px; font-weight: 800; margin-bottom: 4px; color: var(--text-light); text-transform: uppercase; letter-spacing: 0.5px;}
        input, select { width: 100%; padding: 12px; border: 2px solid #f0edea; border-radius: 14px; font-family: 'Nunito'; font-size: 15px; background: white; }
        
        .btn-main { width: 100%; background: var(--primary); color: white; padding: 14px; border: none; border-radius: 14px; font-weight: 800; font-size: 14px; margin-top: 5px; display: flex; justify-content: center; align-items: center; gap: 8px; cursor: pointer; }
        .btn-secondary { background: white; color: var(--primary); border: 2px solid var(--primary); }

        .kpi-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .kpi-card { background: white; border-radius: 20px; padding: 12px; text-align: center; box-shadow: 0 4px 12px rgba(0,0,0,0.02); display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .kpi-card h3 { font-size: 9px; text-transform: uppercase; color: var(--text-light); margin: 0 0 4px 0; font-weight: 800;}
        .kpi-card h2 { margin: 0; font-size: 18px; font-weight: 900; }
        .progress-text { font-size: 11px; font-weight: 900; color: var(--success); margin-top: 4px; display: flex; justify-content: center; align-items: center; gap: 3px;}

        .search-container { display: flex; gap: 8px; margin-bottom: 12px; }
        .btn-search { background: var(--accent); color: white; border: none; border-radius: 14px; width: 60px; display: flex; justify-content: center; align-items: center; font-size: 24px; cursor: pointer;}

        .list-item { display: flex; justify-content: space-between; align-items: center; background: white; padding: 12px; border-radius: 15px; margin-bottom: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.02); }
        .list-item .info { display: flex; flex-direction: column; flex: 1; gap: 2px; }
        .list-item .stats { font-weight: 800; color: var(--primary-dark); text-align: right; min-width: 70px; display: flex; flex-direction: column; align-items: flex-end; gap: 4px; }
        .delete-btn { color: #e0d8d5; background: none; border: none; font-size: 18px; cursor: pointer; }

        .row { display: flex; gap: 10px; }
        .row .form-group { flex: 1; }

        .chart-wrapper { position: relative; height: 180px; width: 100%; background: white; border-radius: 20px; padding: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.02); margin-top: 10px; }
        .section-title { font-size: 15px; font-weight: 800; color: var(--primary-dark); margin: 15px 0 10px 0; display: flex; justify-content: space-between; align-items: center;}
        
        #ai-response { display: none; background: #fffdf2; border: 2px solid #ffe58f; border-radius: 16px; padding: 15px; margin-bottom: 15px; }
        .ai-loading { text-align: center; color: var(--text-light); font-size: 13px; font-weight: 800; padding: 10px; }
        .health-badge { display: inline-block; padding: 6px 10px; border-radius: 10px; font-size: 11px; font-weight: 800; margin-top: 5px;}
        .badge-good { background: #e8f5e9; color: #2e7d32; }
        .badge-warn { background: #fff8e1; color: #f57f17; }

        #baddie-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(90, 80, 75, 0.7); backdrop-filter: blur(8px); z-index: 9999; justify-content: center; align-items: center; padding: 20px; }
        .modal-content { background: white; border-radius: 30px; padding: 35px 25px; text-align: center; max-width: 350px; border: 4px solid var(--accent); }
    </style>
</head>
<body>

    <div id="baddie-modal">
        <div class="modal-content">
            <i class="ph-fill ph-shooting-star" style="color: var(--gold); font-size: 50px;"></i>
            <h2 style="font-family: 'Fredoka'; color: var(--accent); font-size: 26px; margin: 10px 0;">¬°Meta Lograda!</h2>
            <p id="recompensa-texto" style="font-family:'Fredoka'; font-weight: 700; color: var(--primary-dark); font-size: 18px; background: #f2fbf6; padding: 15px; border-radius: 16px; border: 2px dashed var(--success); margin-bottom: 20px;"></p>
            <button class="btn-main" onclick="document.getElementById('baddie-modal').style.display='none'"><i class="ph-bold ph-heart"></i> ¬°Lo merezco! ‚ú®</button>
        </div>
    </div>

    <div class="app-wrapper">
        <header class="baddie-banner">
            <div class="date-mini">
                <i class="ph-fill ph-calendar-blank"></i>
                <input type="date" id="global-fecha" onchange="cambioFechaGlobal()">
            </div>
            <h1>From Fattie to Baddie</h1>
            <p>AI Assistant <i class="ph-fill ph-sparkle" style="color: var(--gold);"></i></p>
        </header>

        <div id="cal-warning" class="alert-box"></div>
        <div id="fattie-warning" class="alert-box" style="background-color: #5a504b;">
            <i class="ph-fill ph-moon"></i> <span>Tarde y sin ejercicio. ¬°Peligro Fattie Zone!</span>
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('dashboard', this)"><i class="ph-fill ph-chart-pie-slice"></i>Resumen</button>
            <button class="tab-btn" onclick="switchTab('medidas', this)"><i class="ph-fill ph-ruler"></i>Cuerpo</button>
            <button class="tab-btn" onclick="switchTab('nutricion', this)"><i class="ph-fill ph-magic-wand"></i>Diario</button>
            <button class="tab-btn" onclick="switchTab('config', this)"><i class="ph-fill ph-target"></i>Metas</button>
        </div>

        <div class="glass-panel">
            
            <div id="dashboard" class="tab-content active">
                <div class="kpi-card" style="background: var(--primary); color: white; margin-bottom: 12px; width: 100%;">
                    <h3 style="color: rgba(255,255,255,0.8);">Calor√≠as Restantes</h3>
                    <h2 id="cal-restantes" style="font-size: 26px;">-- kcal</h2>
                    <div style="font-size: 10px; margin-top: 4px; font-weight: 700; opacity: 0.9;" id="cal-detalle">Cargando...</div>
                </div>
                <div class="kpi-grid">
                    <div class="kpi-card"><h3>D√©ficit Real</h3><h2 id="deficit-hoy" style="color: var(--accent);">0</h2></div>
                    <div class="kpi-card"><h3>Prote√≠nas</h3><h2 id="prot-hoy" style="color: var(--primary-dark);">0g</h2></div>
                </div>
                <div class="section-title"><span>Evoluci√≥n</span><i class="ph-fill ph-sparkle" style="color: var(--gold);"></i></div>
                <div class="kpi-grid">
                    <div class="kpi-card"><h3>Peso</h3><div id="prog-peso" class="progress-text">--</div></div>
                    <div class="kpi-card"><h3>Cintura</h3><div id="prog-cintura" class="progress-text">--</div></div>
                    <div class="kpi-card"><h3>Cadera</h3><div id="prog-cadera" class="progress-text">--</div></div>
                    <div class="kpi-card"><h3>Busto</h3><div id="prog-busto" class="progress-text">--</div></div>
                </div>
                <div id="health-indicators" style="background: #ffffff; padding: 12px; border-radius: 18px; margin-bottom: 15px; font-size: 12px; text-align: center; box-shadow: 0 4px 12px rgba(0,0,0,0.02);">
                    <strong style="color: var(--primary-dark);">ICC:</strong> <span id="icc-value" style="font-weight: 900;">--</span> | <span id="icc-badge" class="health-badge">Calculando...</span>
                </div>
                <div class="chart-wrapper">
                    <canvas id="graficoPeso"></canvas>
                </div>
            </div>

            <div id="medidas" class="tab-content">
                <div class="section-title">Medidas del D√≠a</div>
                <div class="row">
                    <div class="form-group"><label>Peso (kg)</label><input type="number" id="peso" step="0.1"></div>
                    <div class="form-group"><label>Busto (cm)</label><input type="number" id="busto" step="0.1"></div>
                </div>
                <div class="row">
                    <div class="form-group"><label>Cintura (cm)</label><input type="number" id="cintura" step="0.1"></div>
                    <div class="form-group"><label>Cadera (cm)</label><input type="number" id="cadera" step="0.1"></div>
                </div>
                <button class="btn-main" onclick="guardarMedidas()"><i class="ph-bold ph-floppy-disk"></i> Guardar del D√≠a</button>
            </div>

            <div id="nutricion" class="tab-content">
                <div class="section-title">Nutricionista AI</div>
                <div class="search-container">
                    <input type="text" id="busqueda-ai" placeholder="Ej: Dos huevos duros y t√©..." onkeydown="if(event.key==='Enter') consultarAI()">
                    <button class="btn-search" onclick="consultarAI()"><i class="ph-fill ph-lightning"></i></button>
                </div>
                
                <div id="ai-response">
                    <div id="ai-texto"></div>
                    <button class="btn-main" id="btn-add-ai" style="background: var(--success); margin-top: 10px;"><i class="ph-bold ph-plus"></i> A√±adir al Diario</button>
                </div>
                <div id="ai-loading" class="ai-loading" style="display:none;"><i class="ph-bold ph-spinner ph-spin"></i> Analizando plato...</div>
                
                <div class="section-title" style="margin-top: 15px;">A√±adir Manualmente</div>
                <div class="form-group"><label>Alimento</label><input type="text" id="man-nombre" placeholder="Ej: Taza de avena..."></div>
                <div class="row">
                    <div class="form-group"><label>Kcal</label><input type="number" id="man-kcal"></div>
                    <div class="form-group"><label>Prote√≠nas (g)</label><input type="number" id="man-prot"></div>
                </div>
                <button class="btn-main btn-secondary" onclick="agregarComidaManual()" style="margin-bottom: 25px;">+ Ingreso Manual</button>

                <div class="section-title">Comidas de Hoy</div>
                <div id="lista-comidas"></div>
                
                <div class="section-title" style="margin-top: 25px;">Ejercicio F√≠sico</div>
                <div class="form-group"><label>Actividad</label><input type="text" id="ej-nombre" placeholder="Ej: Pilates, Cardio..."></div>
                <div class="row">
                    <div class="form-group"><label>Minutos</label><input type="number" id="ej-tiempo"></div>
                    <div class="form-group"><label>Kcal Quemadas</label><input type="number" id="ej-kcal"></div>
                </div>
                <button class="btn-main btn-secondary" onclick="agregarEjercicio()">+ A√±adir Ejercicio</button>
                <div id="lista-ejercicios" style="margin-top:15px;"></div>
            </div>

            <div id="config" class="tab-content">
                <div class="section-title">Perfil Base</div>
                <div class="row">
                    <div class="form-group"><label>Altura (cm)</label><input type="number" id="c-alt"></div>
                    <div class="form-group"><label>Edad</label><input type="number" id="c-edad"></div>
                </div>
                <div class="form-group"><label>Peso Inicio Oficial</label><input type="number" id="c-peso-i"></div>
                <div class="form-group">
                    <label>Actividad F√≠sica (NEAT)</label>
                    <select id="c-act">
                        <option value="1.2">Sedentario (Menos de 5k pasos)</option>
                        <option value="1.3">Ligero (5k - 8k pasos)</option>
                        <option value="1.45">Moderado (8k - 10k pasos)</option>
                        <option value="1.6">Activo (M√°s de 10k pasos)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>D√©ficit Diario Deseado</label>
                    <select id="c-deficit">
                        <option value="300">Suave (-300 kcal)</option>
                        <option value="500">Recomendado (-500 kcal)</option>
                        <option value="700">Agresivo (-700 kcal)</option>
                    </select>
                </div>
                
                <div class="form-group" style="background: #fff0f0; padding: 10px; border-radius: 12px; margin-top: 15px;">
                    <label style="color: var(--danger);">Gemini API Key (Privada)</label>
                    <input type="password" id="c-apikey" placeholder="Pega tu llave aqu√≠...">
                </div>
                
                <button class="btn-main" onclick="guardarConfig()">Actualizar Perfil</button>
                <button class="btn-main" style="background-color: #e2e8e5; color: var(--primary-dark); margin-top: 10px;" onclick="descargarRespaldo()"><i class="ph-bold ph-download-simple"></i> Respaldar Datos</button>

                <div class="section-title" style="margin-top: 30px; color: var(--accent);">Metas y Proyecciones</div>
                <div class="row">
                    <input type="number" id="m-peso" placeholder="Meta kg" style="flex:1;">
                    <input type="text" id="m-premio" placeholder="Premio" style="flex:2;">
                </div>
                <button class="btn-main btn-secondary" onclick="agregarMeta()">Crear Meta</button>
                <div id="lista-metas" style="margin-top: 15px;"></div>
            </div>
        </div>
    </div>

    <script>
        if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('sw.js'); }); }
        
        let db = { registros: {}, metas: [], config: { altura: 160, edad: '', actividad: 1.2, pesoI: '', deficit: 500, apiKey: '' } };
        let currentAIResult = null; 
        let chart = null;

        function init() {
            try {
                const saved = localStorage.getItem('baddieData_V25');
                if (saved) db = JSON.parse(saved);
                document.getElementById('global-fecha').valueAsDate = new Date();
                cargarConfigUI(); 
                cambioFechaGlobal();
            } catch (e) { localStorage.clear(); location.reload(); }
        }

        function switchTab(id, btn) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            btn.classList.add('active'); 
            cambioFechaGlobal();
        }

        function cambioFechaGlobal() {
            const f = document.getElementById('global-fecha').value;
            if (!db.registros[f]) db.registros[f] = { peso:0, cintura:0, cadera:0, busto:0, comidas:[], ejercicios:[] };
            const hoy = db.registros[f];
            document.getElementById('peso').value = hoy.peso || '';
            document.getElementById('cintura').value = hoy.cintura || '';
            document.getElementById('cadera').value = hoy.cadera || '';
            document.getElementById('busto').value = hoy.busto || '';
            renderDiario(); renderMetas(); actualizarDashboard(); checkFattieZone();
        }

       // --- MOTOR GEMINI A PRUEBA DE FALLOS ---
        async function fetchGemini(prompt, key, modelo) {
            // Volvemos a v1beta que es donde est√°n los modelos m√°s r√°pidos (Flash) de √∫ltima generaci√≥n
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${modelo}:generateContent?key=${key}`;
            const res = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    contents: [{ parts: [{ text: prompt }] }] 
                })
            });
            const data = await res.json();
            if (!res.ok) throw new Error(data.error?.message || "Error en la API");
            return data;
        }

     async function consultarAI() {
            const key = db.config.apiKey;
            if (!key) return alert("‚ùå No hay API Key guardada.");
            
            alert("Probando conexi√≥n directa con Google...");
            
            // Usamos el modelo m√°s b√°sico y estable
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${key}`;
            
            try {
                const res = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: "Hola, dime 'funciona' en formato JSON." }] }] })
                });
                
                const data = await res.json();
                console.log("Respuesta cruda de Google:", data);
                
                if (!res.ok) {
                    // AQU√ç VEREMOS EL ERROR REAL
                    alert(`üö® ERROR DE GOOGLE:\nC√≥digo: ${res.status}\nMensaje: ${data.error?.message}`);
                } else {
                    alert("‚úÖ ¬°LA API KEY FUNCIONA! El problema era otra cosa.");
                }
                
            } catch (e) {
                alert(`‚ö†Ô∏è Error de red o conexi√≥n: ${e.message}`);
            }
        }

        function addComidaAI() {
            const f = document.getElementById('global-fecha').value;
            db.registros[f].comidas.push({ id: Date.now(), n: currentAIResult.nombre, k: currentAIResult.calorias, p: currentAIResult.proteinas });
            save(); cambioFechaGlobal();
            document.getElementById('ai-response').style.display = 'none';
            document.getElementById('busqueda-ai').value = '';
        }

        function agregarComidaManual() {
            const f = document.getElementById('global-fecha').value;
            const n = document.getElementById('man-nombre').value;
            const k = parseInt(document.getElementById('man-kcal').value);
            const p = parseInt(document.getElementById('man-prot').value) || 0; 
            
            if (!n || isNaN(k)) return alert("¬°Ups! Recuerda ingresar el nombre y las calor√≠as.");
            
            db.registros[f].comidas.push({ id: Date.now(), n: n, k: k, p: p });
            save(); 
            cambioFechaGlobal();
            
            document.getElementById('man-nombre').value = ''; 
            document.getElementById('man-kcal').value = ''; 
            document.getElementById('man-prot').value = '';
        }

        function agregarEjercicio() {
            const f = document.getElementById('global-fecha').value;
            const n = document.getElementById('ej-nombre').value;
            const t = document.getElementById('ej-tiempo').value;
            const k = parseFloat(document.getElementById('ej-kcal').value);
            if(!n || isNaN(k)) return;
            db.registros[f].ejercicios.push({id: Date.now(), n, t, k});
            save(); cambioFechaGlobal();
            document.getElementById('ej-nombre').value = ''; document.getElementById('ej-tiempo').value = ''; document.getElementById('ej-kcal').value = '';
        }

        function guardarMedidas() {
            const f = document.getElementById('global-fecha').value;
            const p = parseFloat(document.getElementById('peso').value) || 0;
            db.registros[f].peso = p;
            db.registros[f].cintura = parseFloat(document.getElementById('cintura').value) || 0;
            db.registros[f].cadera = parseFloat(document.getElementById('cadera').value) || 0;
            db.registros[f].busto = parseFloat(document.getElementById('busto').value) || 0;
            db.metas.forEach(m => {
                if(!m.done && p > 0 && p <= m.p) {
                    m.done = true; document.getElementById('recompensa-texto').innerText = m.r;
                    document.getElementById('baddie-modal').style.display = 'flex';
                }
            });
            save(); cambioFechaGlobal(); alert("Guardado con √©xito");
        }

        function renderDiario() {
            const f = document.getElementById('global-fecha').value;
            const lc = document.getElementById('lista-comidas'); lc.innerHTML = '';
            db.registros[f].comidas.forEach(c => {
                lc.innerHTML += `<div class="list-item"><div class="info"><b>${c.n}</b><small>${c.p}g prot</small></div><div class="stats"><span style="color:var(--accent);"><i class="ph-fill ph-fire"></i> ${c.k}</span><button class="delete-btn" onclick="borrarItem('c',${c.id})"><i class="ph-bold ph-trash"></i></button></div></div>`;
            });
            const le = document.getElementById('lista-ejercicios'); le.innerHTML = '';
            db.registros[f].ejercicios.forEach(e => {
                le.innerHTML += `<div class="list-item"><div class="info"><b>${e.n}</b><small>${e.t} min</small></div><div class="stats"><span style="color:var(--success);"><i class="ph-bold ph-trend-down"></i> ${e.k}</span><button class="delete-btn" onclick="borrarItem('e',${e.id})"><i class="ph-bold ph-trash"></i></button></div></div>`;
            });
        }

        function actualizarDashboard() {
            const f = document.getElementById('global-fecha').value;
            const hoy = db.registros[f]; const conf = db.config;
            let tIn = 0, tP = 0, tOut = 0;
            hoy.comidas.forEach(c => { tIn += c.k; tP += c.p; });
            hoy.ejercicios.forEach(e => { tOut += e.k; });
            const pesos = Object.keys(db.registros).sort().map(k=>db.registros[k].peso).filter(p=>p>0);
            const uPeso = hoy.peso || pesos[pesos.length-1] || conf.pesoI || 0;
            
            if(uPeso > 0 && conf.altura && conf.edad) {
                const bmr = (10 * uPeso) + (6.25 * conf.altura) - (5 * conf.edad) - 161;
                const neat = Math.round(bmr * conf.actividad); 
                const metaDef = parseFloat(conf.deficit || 500);
                const meta = neat - metaDef; 
                const rest = meta - tIn + tOut;
                
                document.getElementById('cal-restantes').innerText = rest + ' kcal';
                document.getElementById('cal-detalle').innerText = `TDEE: ${neat} | Comida: ${tIn} | Ejer: ${tOut}`;
                document.getElementById('prot-hoy').innerText = tP + 'g';
                const defReal = (neat + tOut) - tIn;
                document.getElementById('deficit-hoy').innerText = (defReal > 0 ? '-' : '+') + Math.abs(defReal);
                
                const calWarn = document.getElementById('cal-warning');
                if (rest <= 200 && rest > 0) {
                    calWarn.style.display = 'flex'; calWarn.innerHTML = '<i class="ph-fill ph-warning-octagon"></i> ¬°PELIGRO! Cerca de zona Fattie';
                } else if (rest <= 0) {
                    calWarn.style.display = 'flex'; calWarn.innerHTML = '<i class="ph-fill ph-skull"></i> ¬°ZONA FATTIE! L√≠mite superado';
                } else { calWarn.style.display = 'none'; }
                
                if(hoy.cintura && hoy.cadera) {
                    const icc = (hoy.cintura / hoy.cadera).toFixed(2);
                    document.getElementById('icc-value').innerText = icc;
                    const badge = document.getElementById('icc-badge');
                    badge.innerText = icc < 0.81 ? 'Bajo Riesgo ‚ú®' : 'Riesgo Moderado';
                    badge.className = `health-badge ${icc < 0.81 ? 'badge-good' : 'badge-warn'}`;
                }
            }
            renderMejoras(); renderChart();
        }

        function renderMejoras() {
            const fechas = Object.keys(db.registros).sort();
            const getDiff = (key) => {
                const vals = fechas.map(f=>db.registros[f][key]).filter(v=>v>0);
                if(vals.length < 1) return '--';
                const first = (key==='peso' && db.config.pesoI) ? db.config.pesoI : vals[0];
                const diff = (first - vals[vals.length-1]).toFixed(1);
                return (diff > 0 ? 'üëá -' : (diff < 0 ? 'üìà +' : '')) + Math.abs(diff);
            };
            document.getElementById('prog-peso').innerText = getDiff('peso');
            document.getElementById('prog-cintura').innerText = getDiff('cintura');
            document.getElementById('prog-cadera').innerText = getDiff('cadera');
            document.getElementById('prog-busto').innerText = getDiff('busto');
        }

        function renderMetas() {
            const cont = document.getElementById('lista-metas'); cont.innerHTML = '';
            const pesos = Object.values(db.registros).map(r=>r.peso).filter(p=>p>0);
            const uPeso = pesos[pesos.length-1] || db.config.pesoI || 0;
            const def = parseFloat(db.config.deficit || 500);
            db.metas.forEach(m => {
                let proy = '';
                if(!m.done && uPeso > m.p) {
                    const dias = Math.ceil(((uPeso - m.p) * 7700) / def);
                    const fechaE = new Date(); fechaE.setDate(fechaE.getDate() + dias);
                    proy = `<div style="font-size:11px; margin-top:8px; color:var(--primary-dark); background:rgba(255,255,255,0.7); padding:8px; border-radius:12px; display:flex; align-items:center; gap:8px;">
                        <i class="ph-fill ph-calendar-heart" style="font-size:24px; color:var(--accent);"></i>
                        <div><span style="font-weight:900; color:var(--text-main);">Faltan aprox. ${dias} d√≠as</span><br>Llegar√°s el ${fechaE.toLocaleDateString('es-ES')}</div>
                    </div>`;
                }
                cont.innerHTML += `<div class="list-item" style="border-left:6px solid ${m.done?'var(--success)':'var(--accent)'}">
                    <div class="info"><b>Bajar a ${m.p} kg</b><small>üéÅ ${m.r}</small>${proy}</div>
                    <button class="delete-btn" onclick="delMeta(${m.id})"><i class="ph-bold ph-trash"></i></button>
                </div>`;
            });
        }

        function agregarMeta() {
            const p = parseFloat(document.getElementById('m-peso').value);
            const r = document.getElementById('m-premio').value;
            if(!p || !r) return;
            db.metas.push({id:Date.now(), p, r, done:false});
            save(); cambioFechaGlobal();
            document.getElementById('m-peso').value = ''; document.getElementById('m-premio').value = '';
        }
        function delMeta(id) { if(confirm("¬øBorrar?")) { db.metas = db.metas.filter(m=>m.id!==id); save(); cambioFechaGlobal(); } }
        function borrarItem(tipo, id) {
            const f = document.getElementById('global-fecha').value;
            if(tipo==='c') db.registros[f].comidas = db.registros[f].comidas.filter(i=>i.id!==id);
            else db.registros[f].ejercicios = db.registros[f].ejercicios.filter(i=>i.id!==id);
            save(); cambioFechaGlobal();
        }
        
        function cargarConfigUI() {
            document.getElementById('c-alt').value = db.config.altura || '';
            document.getElementById('c-edad').value = db.config.edad || '';
            document.getElementById('c-peso-i').value = db.config.pesoI || '';
            document.getElementById('c-act').value = db.config.actividad || 1.2;
            document.getElementById('c-deficit').value = db.config.deficit || 500;
            document.getElementById('c-apikey').value = db.config.apiKey || '';
        }
        
        function guardarConfig() {
            db.config.altura = document.getElementById('c-alt').value;
            db.config.edad = document.getElementById('c-edad').value;
            db.config.pesoI = document.getElementById('c-peso-i').value;
            db.config.actividad = document.getElementById('c-act').value;
            db.config.deficit = document.getElementById('c-deficit').value;
            db.config.apiKey = document.getElementById('c-apikey').value.trim();
            save(); alert("Perfil actualizado"); cambioFechaGlobal();
        }
        
        function descargarRespaldo() {
            const blob = new Blob([JSON.stringify(db)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = `Baddie_Backup.json`; a.click();
        }
        
        function save() { localStorage.setItem('baddieData_V25', JSON.stringify(db)); }
        
        function renderChart() {
            const ctx = document.getElementById('graficoPeso').getContext('2d');
            const fechas = Object.keys(db.registros).sort().slice(-7);
            const dataP = fechas.map(f=>db.registros[f].peso).filter(p=>p>0);
            if (chart) chart.destroy();
            chart = new Chart(ctx, {
                type: 'line', data: { labels: fechas.map(f=>f.split('-')[2]), datasets: [{ data: dataP, borderColor: '#f4a298', borderWidth: 3, tension: 0.4, fill: true, backgroundColor: 'rgba(244, 162, 152, 0.05)', pointBackgroundColor: '#fff', pointRadius: 4 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { display: true, grid: { color: '#f0edea' } }, x: { grid: { display: false } } } }
            });
        }
        
        function checkFattieZone() {
            const hoyStr = new Date().toISOString().split('T')[0];
            const hora = new Date().getHours();
            const hayEjer = db.registros[hoyStr]?.ejercicios.length > 0;
            document.getElementById('fattie-warning').style.display = (hora >= 22 && !hayEjer) ? 'flex' : 'none';
        }
        window.onload = init;
    </script>
</body>
</html>
