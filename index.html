<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#84a99c">
    <link rel="apple-touch-icon" href="icono.png">
    <link rel="icon" type="image/png" href="icono.png">

    <title>Baddie Wellness Tracker</title>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@600;700&family=Nunito:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    
    <style>
        :root { 
            --primary: #84a99c; --primary-dark: #6b8d81; --bg-color: #fdf6f5; 
            --text-main: #5a504b; --text-light: #a09894; --accent: #f4a298; 
            --danger: #f28b82; --success: #81c784; --gold: #ffd54f;
        }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body { 
            font-family: 'Nunito', sans-serif; background-color: var(--bg-color); 
            color: var(--text-main); margin: 0; padding: 15px; 
            display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; 
            padding-top: env(safe-area-inset-top); padding-bottom: env(safe-area-inset-bottom);
        }

        body::before {
            content: ""; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background-image: url('fondo.png'); background-size: cover; background-position: center; z-index: -1;
        }

        .app-wrapper { width: 100%; max-width: 500px; display: flex; flex-direction: column; gap: 15px; padding-bottom: 30px; }
        
        .baddie-banner { 
            background-image: linear-gradient(rgba(0, 0, 0, 0.15), rgba(0, 0, 0, 0.15)), url('banner.png'); 
            background-size: cover; background-position: center; color: white; text-align: center; 
            padding: 40px 20px; border-radius: 24px; box-shadow: 0 8px 20px rgba(0,0,0,0.08);
        }
        
        .baddie-banner h1 {
            margin: 0; font-size: 38px; font-family: 'Fredoka', sans-serif; font-weight: 700; color: #ffffff;
            text-shadow: -2.5px -2.5px 0 #5a504b, 2.5px -2.5px 0 #5a504b, -2.5px 2.5px 0 #5a504b, 2.5px 2.5px 0 #5a504b, 0px -2.5px 0 #5a504b, 0px 2.5px 0 #5a504b, -2.5px 0px 0 #5a504b, 2.5px 0px 0 #5a504b, 4px 6px 0 rgba(90, 80, 75, 0.25);
            letter-spacing: 1.5px; line-height: 1.2;
        }

        .date-card {
            background: #ffffff; border-radius: 20px; padding: 8px 20px; display: flex;
            align-items: center; justify-content: center; width: max-content; margin: 0 auto; gap: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.03); border: 2px solid #ffffff;
        }
        .date-card input { border: none; background: transparent; font-size: 14px; font-weight: 800; color: var(--text-main); outline: none; font-family: 'Nunito'; }

        .tabs { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .tab-btn { 
            background: #ffffff; border: none; padding: 12px 5px; border-radius: 16px; 
            font-family: 'Nunito'; font-size: 11px; font-weight: 800; color: var(--text-light); 
            display: flex; flex-direction: column; align-items: center; gap: 5px; box-shadow: 0 4px 15px rgba(0,0,0,0.04);
        }
        .tab-btn.active { background: var(--primary); color: white; }

        .glass-panel { background: rgba(255, 255, 255, 0.88); backdrop-filter: blur(15px); border-radius: 24px; padding: 22px; box-shadow: 0 8px 30px rgba(0,0,0,0.05); }

        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.2s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; } }

        input, select { width: 100%; padding: 12px; border: 2px solid #f0edea; border-radius: 14px; font-family: 'Nunito'; font-size: 16px; background: white; }
        .btn-main { width: 100%; background: var(--primary); color: white; padding: 14px; border: none; border-radius: 14px; font-weight: 800; font-size: 15px; margin-top: 10px; display: flex; justify-content: center; align-items: center; gap: 8px; }
        .btn-secondary { background: white; color: var(--primary); border: 2px solid var(--primary); }

        .kpi-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 15px; }
        .kpi-card { background: white; border-radius: 20px; padding: 15px; text-align: center; box-shadow: 0 4px 12px rgba(0,0,0,0.02); }
        .kpi-card h3 { font-size: 10px; text-transform: uppercase; color: var(--text-light); margin: 0 0 5px 0; }
        .kpi-card h2 { margin: 0; font-size: 22px; font-weight: 900; }

        .list-item { display: flex; justify-content: space-between; align-items: center; background: white; padding: 12px; border-radius: 15px; margin-bottom: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.02); }
        .delete-btn { color: #e0d8d5; background: none; border: none; font-size: 20px; }

        /* MODAL */
        #baddie-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(8px); z-index: 9999; justify-content: center; align-items: center; padding: 20px; }
        .modal-content { background: white; border-radius: 30px; padding: 30px; text-align: center; max-width: 350px; border: 4px solid var(--accent); }

        .resultados-api { display: none; background: white; border-radius: 15px; margin-bottom: 10px; max-height: 200px; overflow-y: auto; border: 1px solid #eee; }
        .resultado-item { padding: 10px; border-bottom: 1px solid #f9f9f9; }
    </style>
</head>
<body>

    <div id="baddie-modal">
        <div class="modal-content">
            <i class="ph-fill ph-shooting-star" style="color: var(--gold); font-size: 50px;"></i>
            <h2 style="font-family: 'Fredoka'; color: var(--accent);">¬°Meta Lograda!</h2>
            <p id="recompensa-texto" style="font-weight: 800; background: #fdf6f5; padding: 15px; border-radius: 15px; border: 2px dashed var(--success);"></p>
            <button class="btn-main" onclick="document.getElementById('baddie-modal').style.display='none'">¬°Lo merezco! ‚ú®</button>
        </div>
    </div>

    <div class="app-wrapper">
        <header class="baddie-banner">
            <h1>From Fattie to Baddie</h1>
            <p>Just do it <i class="ph-fill ph-star" style="color: var(--gold);"></i></p>
        </header>

        <div class="date-card">
            <i class="ph-fill ph-calendar-heart"></i>
            <input type="date" id="global-fecha" onchange="actualizarTodo()">
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('dashboard', this)"><i class="ph-fill ph-chart-pie-slice"></i>Resumen</button>
            <button class="tab-btn" onclick="switchTab('medidas', this)"><i class="ph-fill ph-ruler"></i>Cuerpo</button>
            <button class="tab-btn" onclick="switchTab('diario', this)"><i class="ph-fill ph-book-heart"></i>Diario</button>
            <button class="tab-btn" onclick="switchTab('config', this)"><i class="ph-fill ph-gear"></i>Metas</button>
        </div>

        <div class="glass-panel">
            <div id="dashboard" class="tab-content active">
                <div class="kpi-card" style="background: var(--primary); color: white; margin-bottom: 15px;">
                    <h3 style="color: rgba(255,255,255,0.8);">Calor√≠as Restantes</h3>
                    <h2 id="cal-restantes">--</h2>
                    <p id="cal-detalle" style="font-size: 10px; margin-top: 5px;"></p>
                </div>
                <div class="kpi-grid">
                    <div class="kpi-card"><h3>Prote√≠na</h3><h2 id="prot-hoy">0g</h2></div>
                    <div class="kpi-card"><h3>D√©ficit Real</h3><h2 id="deficit-hoy">0</h2></div>
                </div>
                <div id="salud-panel" style="background:white; padding:12px; border-radius:15px; text-align:center; font-size:12px; margin-bottom:15px;">
                    <b>ICC:</b> <span id="icc-val">--</span> | <span id="icc-status">Sin datos</span>
                </div>
                <canvas id="graficoPeso"></canvas>
            </div>

            <div id="medidas" class="tab-content">
                <div class="form-group"><label>Peso (kg)</label><input type="number" id="peso" step="0.1"></div>
                <div class="row">
                    <div class="form-group"><label>Cintura</label><input type="number" id="cintura"></div>
                    <div class="form-group"><label>Cadera</label><input type="number" id="cadera"></div>
                </div>
                <button class="btn-main" onclick="guardarMedidas()"><i class="ph-bold ph-check"></i> Guardar del D√≠a</button>
            </div>

            <div id="diario" class="tab-content">
                <div style="display:flex; gap:8px; margin-bottom:15px;">
                    <input type="text" id="busqueda" placeholder="Buscar en Chile...">
                    <button class="btn-main" style="width:50px; margin:0;" onclick="buscarAPI()"><i class="ph-bold ph-magnifying-glass"></i></button>
                </div>
                <div id="res-api" class="resultados-api"></div>
                <div class="row">
                    <div class="form-group" style="flex:2;"><label>Nombre</label><input type="text" id="comida-n"></div>
                    <div class="form-group"><label>Gramos</label><input type="number" id="comida-g" value="100" oninput="recalc()"></div>
                </div>
                <div class="row">
                    <div class="form-group"><label>Kcal</label><input type="number" id="comida-k"></div>
                    <div class="form-group"><label>Prot</label><input type="number" id="comida-p"></div>
                </div>
                <button class="btn-main btn-secondary" onclick="addComida()">+ Agregar Comida</button>
                <div id="lista-comidas" style="margin-top:15px;"></div>
            </div>

            <div id="config" class="tab-content">
                <div class="row">
                    <div class="form-group"><label>Altura</label><input type="number" id="c-alt" value="160"></div>
                    <div class="form-group"><label>Edad</label><input type="number" id="c-edad"></div>
                </div>
                <div class="form-group">
                    <label>Actividad (Pasos)</label>
                    <select id="c-act">
                        <option value="1.2">Sedentario (<5k)</option>
                        <option value="1.3">Ligero (5k-8k)</option>
                        <option value="1.45">Moderado (8k-10k)</option>
                        <option value="1.6">Activo (>10k)</option>
                    </select>
                </div>
                <button class="btn-main" onclick="saveConfig()">Actualizar Perfil</button>
                
                <h2 style="font-family:'Fredoka'; font-size:18px; margin-top:25px;">Metas y Proyecciones</h2>
                <div class="row">
                    <input type="number" id="m-peso" placeholder="Meta kg" style="flex:1;">
                    <input type="text" id="m-premio" placeholder="Premio" style="flex:2;">
                </div>
                <button class="btn-main btn-secondary" onclick="addMeta()">A√±adir Meta</button>
                <div id="lista-metas" style="margin-top:15px;"></div>
            </div>
        </div>
    </div>

    <script>
        let db = { registros: {}, metas: [], config: { altura: 160, edad: '', actividad: 1.2, deficit: 500, pesoI: '' } };
        let baseK = 0, baseP = 0;
        let chart = null;

        function init() {
            try {
                const saved = localStorage.getItem('baddieData_v11');
                if (saved) db = JSON.parse(saved);
                document.getElementById('global-fecha').valueAsDate = new Date();
                actualizarTodo();
            } catch (e) {
                localStorage.clear();
                location.reload();
            }
        }

        function switchTab(id, btn) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            btn.classList.add('active');
            actualizarTodo();
        }

        function actualizarTodo() {
            const fecha = document.getElementById('global-fecha').value;
            if (!db.registros[fecha]) db.registros[fecha] = { peso:0, cintura:0, cadera:0, comidas:[], ejercicios:[] };
            
            // Cargar datos a los inputs
            const hoy = db.registros[fecha];
            document.getElementById('peso').value = hoy.peso || '';
            document.getElementById('cintura').value = hoy.cintura || '';
            document.getElementById('cadera').value = hoy.cadera || '';
            
            renderDiario();
            renderMetas();
            calcDashboard();
        }

        async function buscarAPI() {
            const q = document.getElementById('busqueda').value;
            const resDiv = document.getElementById('res-api');
            if(!q) return;
            resDiv.innerHTML = '<p style="padding:10px; font-size:12px;">Buscando...</p>';
            resDiv.style.display = 'block';
            try {
                const r = await fetch(`https://cl.openfoodfacts.org/cgi/search.pl?search_terms=${q}&json=1&page_size=5`);
                const d = await r.json();
                resDiv.innerHTML = '';
                d.products.forEach(p => {
                    const n = p.product_name_es || p.product_name;
                    const k = Math.round(p.nutriments['energy-kcal_100g'] || 0);
                    const pr = Math.round(p.nutriments['proteins_100g'] || 0);
                    const i = document.createElement('div');
                    i.className = 'resultado-item';
                    i.innerHTML = `<b>${n}</b><br><small>${k} kcal | ${pr}g prot</small>`;
                    i.onclick = () => {
                        document.getElementById('comida-n').value = n;
                        baseK = k; baseP = pr;
                        document.getElementById('comida-g').value = 100;
                        recalc();
                        resDiv.style.display = 'none';
                    };
                    resDiv.appendChild(i);
                });
            } catch(e) { resDiv.style.display = 'none'; }
        }

        function recalc() {
            const g = document.getElementById('comida-g').value / 100;
            document.getElementById('comida-k').value = Math.round(baseK * g);
            document.getElementById('comida-p').value = Math.round(baseP * g);
        }

        function addComida() {
            const f = document.getElementById('global-fecha').value;
            const n = document.getElementById('comida-n').value;
            const k = parseFloat(document.getElementById('comida-k').value);
            const p = parseFloat(document.getElementById('comida-p').value);
            if(!n || isNaN(k)) return;
            db.registros[f].comidas.push({id: Date.now(), n, k, p});
            save(); actualizarTodo();
            document.getElementById('comida-n').value = ''; document.getElementById('comida-k').value = ''; document.getElementById('comida-p').value = '';
        }

        function guardarMedidas() {
            const f = document.getElementById('global-fecha').value;
            db.registros[f].peso = parseFloat(document.getElementById('peso').value);
            db.registros[f].cintura = parseFloat(document.getElementById('cintura').value);
            db.registros[f].cadera = parseFloat(document.getElementById('cadera').value);
            save();
            
            // Check Metas
            db.metas.forEach(m => {
                if(!m.done && db.registros[f].peso <= m.p) {
                    m.done = true;
                    document.getElementById('recompensa-texto').innerText = m.r;
                    document.getElementById('baddie-modal').style.display = 'flex';
                }
            });
            save(); actualizarTodo();
        }

        function renderDiario() {
            const f = document.getElementById('global-fecha').value;
            const cont = document.getElementById('lista-comidas');
            cont.innerHTML = '';
            db.registros[f].comidas.forEach(c => {
                cont.innerHTML += `<div class="list-item">
                    <div><b>${c.n}</b><br><small>${c.p}g prote√≠na</small></div>
                    <div style="display:flex; align-items:center; gap:10px;">
                        <span style="color:var(--accent); font-weight:800;">${c.k} kcal</span>
                        <button class="delete-btn" onclick="delComida(${c.id})"><i class="ph-bold ph-trash"></i></button>
                    </div>
                </div>`;
            });
        }

        function delComida(id) {
            const f = document.getElementById('global-fecha').value;
            db.registros[f].comidas = db.registros[f].comidas.filter(c => c.id !== id);
            save(); actualizarTodo();
        }

        function calcDashboard() {
            const f = document.getElementById('global-fecha').value;
            const hoy = db.registros[f];
            const conf = db.config;
            
            let tK = 0, tP = 0;
            hoy.comidas.forEach(c => { tK += c.k; tP += (c.p || 0); });
            document.getElementById('prot-hoy').innerText = tP + 'g';

            const pesos = Object.values(db.registros).map(r => r.peso).filter(p => p > 0);
            const uPeso = hoy.peso || pesos[pesos.length-1] || 0;

            if(uPeso > 0 && conf.altura && conf.edad) {
                const bmr = (10 * uPeso) + (6.25 * conf.altura) - (5 * conf.edad) - 161;
                const tdee = Math.round(bmr * conf.actividad);
                const meta = tdee - 500;
                const rest = meta - tK;

                document.getElementById('cal-restantes').innerText = rest + ' kcal';
                document.getElementById('cal-detalle').innerText = `TDEE: ${tdee} | Consumido: ${tK}`;
                
                const defReal = tdee - tK;
                document.getElementById('deficit-hoy').innerText = defReal > 0 ? `-${defReal}` : `+${Math.abs(defReal)}`;
                
                if(hoy.cintura && hoy.cadera) {
                    const icc = (hoy.cintura / hoy.cadera).toFixed(2);
                    document.getElementById('icc-val').innerText = icc;
                    document.getElementById('icc-status').innerText = icc < 0.81 ? 'Saludable ‚ú®' : 'Riesgo Moderado';
                }
            }
            renderChart();
        }

        function renderMetas() {
            const cont = document.getElementById('lista-metas');
            cont.innerHTML = '';
            const conf = db.config;
            const pesos = Object.values(db.registros).map(r => r.peso).filter(p => p > 0);
            const uPeso = pesos[pesos.length-1] || 0;

            db.metas.forEach(m => {
                let proy = '';
                if(!m.done && uPeso > m.p) {
                    const dias = Math.ceil(((uPeso - m.p) * 7700) / 500);
                    proy = `<div style="font-size:11px; margin-top:8px; color:var(--primary-dark); font-weight:700;">
                        <i class="ph-fill ph-calendar-check"></i> Faltan aprox. ${dias} d√≠as
                    </div>`;
                }
                cont.innerHTML += `<div class="list-item" style="border-left:5px solid ${m.done?'var(--success)':'var(--accent)'}">
                    <div style="flex:1;"><b>Bajar a ${m.p}kg</b><br><small>üéÅ ${m.r}</small>${proy}</div>
                    <button class="delete-btn" onclick="delMeta(${m.id})"><i class="ph-bold ph-trash"></i></button>
                </div>`;
            });
        }

        function addMeta() {
            const p = parseFloat(document.getElementById('m-peso').value);
            const r = document.getElementById('m-premio').value;
            if(!p || !r) return;
            db.metas.push({id:Date.now(), p, r, done:false});
            save(); actualizarTodo();
        }
        function delMeta(id) { db.metas = db.metas.filter(m => m.id !== id); save(); actualizarTodo(); }
        function saveConfig() {
            db.config.altura = document.getElementById('c-alt').value;
            db.config.edad = document.getElementById('c-edad').value;
            db.config.actividad = document.getElementById('c-act').value;
            save(); alert("Perfil guardado"); actualizarTodo();
        }
        function save() { localStorage.setItem('baddieData_v11', JSON.stringify(db)); }

        function renderChart() {
            const ctx = document.getElementById('graficoPeso').getContext('2d');
            const labels = Object.keys(db.registros).sort().slice(-7);
            const dataP = labels.map(l => db.registros[l].peso).filter(p => p > 0);
            if (chart) chart.destroy();
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels.map(l => l.split('-')[2]),
                    datasets: [{ label: 'Peso', data: dataP, borderColor: '#f4a298', tension: 0.4, fill: true, backgroundColor: 'rgba(244, 162, 152, 0.1)' }]
                },
                options: { plugins: { legend: { display: false } }, scales: { y: { display: false }, x: { grid: { display: false } } } }
            });
        }

        window.onload = init;
    </script>
</body>
</html>
